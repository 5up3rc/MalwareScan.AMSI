namespace MalwareScan.AMSI.Tests
{
    using System.IO;
    using System.Text;

    using MalwareScan.AMSI;

    using Xunit;

    public class VirusScanningTests
    {
        private const string appName = "VirusScan.AMSI TEST library";
        [Fact]
        public void CanDetectEICARInStream()
        {
            var stream = this.CreateStream(@"X5O!P%@AP[4\PZX54(P^)7CC)7}" + @"$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*");
            var subject = new MalwareScanner(appName);
            var result = subject.HasVirus(stream, "eicar.com");
            Assert.True(result);
        }

        private Stream CreateStream(string value)
        {
            var stream = new MemoryStream();
            using (var writer = new StreamWriter(stream, Encoding.UTF8, 1024, true))
            {
                writer.Write(value);
                writer.Flush();
            }

            stream.Position = 0;
            return stream;
        }

        [Fact]
        public void CanDetectEICARInByteArray()
        {
            var arr = Encoding.UTF8.GetBytes(@"X5O!P%@AP[4\PZX54(P^)7CC)7}" + @"$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*");
            var subject = new MalwareScanner(appName);
            var result = subject.HasVirus(arr, "eicar.com");
            Assert.True(result);
        }

        [Fact]
        public void DoesNotDetectInnocousStream()
        {
            var stream = this.CreateStream(@"bob");
            var subject = new MalwareScanner(appName);
            var result = subject.HasVirus(stream, "bob.com");
            Assert.False(result);
        }

        [Fact]
        public void DoesNotDetectInnocousByteArray()
        {
            var arr = Encoding.UTF8.GetBytes(@"bob");
            var subject = new MalwareScanner(appName);
            var result = subject.HasVirus(arr, "bob.com");
            Assert.False(result);
        }

        [Fact]
        public void HandlesStreamPositionInSeekableStream()
        {
            var stream = this.CreateStream(@"X5O!P%@AP[4\PZX54(P^)7CC)7}" + @"$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*");
            stream.Position = 10;
            var subject = new MalwareScanner(appName);
            var result = subject.HasVirus(stream, "eicar.com");
            Assert.True(result);
            Assert.Equal(10, stream.Position);
        }
    }
}

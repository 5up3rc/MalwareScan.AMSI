# Anti Malware scanning in Windows

Provides a wrapper around the [AMSI Interface](https://msdn.microsoft.com/en-us/library/windows/desktop/dn889587(v=vs.85).aspx) that was introduced in Windows 10/Server 2016 to allow applications to scan content for viruses.

**This is very early code right now, use with caution**

**Azure Web Apps seem to have a problem with AMSI - at least from within kestrel. Am investigating...**

## Installation
TBD

## Usage
Initialiase an instance of the MalwareScanner:
```
   var scanner = new MalwareScanner("MyApplications Viruscanner");
```
You may want to keep a copy around as it does some initialisation that is scoped to the lifetime of the object. It will be released when you dispose of the `IDisposable` or, failing that, when the object is garbage collected.
Note that the initialisation is Lazy, so don't worry about creating instances of the object that aren't used.

To scan a stream, call 
```
   var result = scanner.HasVirus(stream, filename);
```
Alternatively, you can pass in a byte array.
If passing in a stream, be aware of some of the limitations of streams. If you are passing in a MemoryStream or a FileStream or similar then everything is fine. But some streams are forward-only, such as the request stream in a web application (if you are reading it directly). This means that they can only be read once, meaning that if you pass such a stream to the scanner, you won't be able to read the stream afterwards. If you read the stream first, then the scanner can't read it; in that scenario the scanner will just see empty content so will return `false` (i.e. "no virus found") - but it *will* log a warning.

## Is it working?
The AMSI interface is only available in Windows 10+ and in Server 2016. Furthermore, if no malware scanner is installed, the scanner will happily tell you it didn't find a virus no matter what you throw at it.
It is a good idea to call the `TestIfItIsWorking` method on application startup and check the result (it should be `true`). The test method will scan a known test virus string (the [EICAR string](https://en.wikipedia.org/wiki/EICAR_test_file)) to confirm that everything is working correctly.
Note that any positive virus scan, including the test one, will cause windows defender to log the detection and on a desktop will pop up a message, so don't call this too often.

## Logging
This library uses [LibLog](https://github.com/damianh/LibLog), meaning it will integrate nicely with most logging frameworks. The default logging level is very quiet and will only log errors and warnings when something goes wrong or a virus is found.
The logger uses a "context" of "MalwareScanner" so if you need to understand what is going on, you may be able to tell your logging framework to include all the `Debug` log messages from that context, to see more details.

## References
- [AMSI Reference](https://msdn.microsoft.com/en-us/library/windows/desktop/dn889587(v=vs.85).aspx)
- [Adam Driscoll's C# AMSI Wrapper](https://github.com/adamdriscoll/AMSI/blob/master/NativeMethods.cs)